---
 - name: techtransfer deployment
   hosts: '{{ hosts }}'
   become: yes
   become_user: root
   become_method: dzdo
   vars:

     - hosts: '{{ hosts }}'
     - site: techtransfer.cancer.gov
     - tier: '{{ tier }}'
     - siteroot: /local/drupal/techtransfer/sites/{{ site }}
     - drupalroot: /local/drupal/techtransfer
     - dbfile: "{{ site }}-{{ tier }}-db"
     - date: "{{ lookup('pipe', 'date +%Y%m%d-%H%M') }}"
     - sitecopy: "{{ site }}-site-{{ tier }}-copy"
     - svnurl: https://ncisvn.nci.nih.gov/svn/ocplttc/branches/dev_20170308/drupal/sites
     - svn_root: /local/drupal/svn_source/sites
     - backups: /local/drupal/backups
     - drupaluser: drupal
     - rsyncsrc: "{{ svn_root }}"


   tasks:
     - name: Clear drush cache
       shell:
         cmd: drush cc all
         chdir: "{{ siteroot }}"

     - name: Take sql dump of {{ tier }} database.
       shell: 
         cmd: "drush sql-dump --gzip --result-file={{ backups }}/{{ dbfile }}-{{ date }}"
         chdir: "{{ siteroot }}"

     - name: Backup site directory
       shell: 
         cmd: tar -czvf {{ backups }}/{{ sitecopy }}-{{ date }}.tgz sites
         chdir: "{{ drupalroot }}"

     - name: Sanitize the local svn repo directory
       file:
         path: "{{ svn_root }}"
         state: absent

     - name: Checkout svn
       subversion:
         repo: "{{ svnurl }}"
         dest: "{{ svn_root }}"
         export: yes
         
         
  
     - name: rsync the sites directory
       shell:
         cmd: rsync -rvcCi --delete {{ rsyncsrc }}/default/modules/  {{ siteroot }}/modules/
       register: rsyncout
     - debug: msg={{ rsyncout }}

     - name: rsync the sites directory
       shell:
         cmd: rsync -rvcCi  {{ rsyncsrc }}/default/themes/  {{ siteroot }}/themes/
       register: rsyncout
     - debug: msg={{ rsyncout }}


     - name: Change ownership of {{ site }} site
       file:
         owner: "{{ drupaluser }}"
         group: "{{ drupaluser }}"
         path: "{{ drupalroot }}"
         recurse: yes

     - name: Find type  directory in all and change permission to 755
       shell:
         cmd: find ../all -type d -print0 | xargs -0 chmod 755
         chdir: "{{ siteroot }}"

     - name: Find type  file in themes and change permission to 644
       shell:
         cmd: find ../all -type f -print0 | xargs -0 chmod 644
         chdir: "{{ siteroot }}"


     - name: Find type  directory in files and change permission to 775
       shell:
         cmd: find files -type d -print0 | xargs -0 chmod 775
         chdir: "{{ siteroot }}"

     - name: Find type  file in files and change permission to 664
       shell:
         cmd: find files -type f -print0 | xargs -0 chmod 644
         chdir: "{{ siteroot }}"

     - name: Find type  directory in files and change group bit
       shell:
         cmd: find files -type d -print0 | xargs -0 chmod g+s
         chdir: "{{ siteroot }}"


     - name: Clear drush cache
       shell:
         cmd: drush cc all
         chdir: "{{ siteroot }}"
     
