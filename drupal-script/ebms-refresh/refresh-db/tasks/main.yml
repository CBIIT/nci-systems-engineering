---
# tasks file for refresh-db

- include_vars: ../../vars.yml

#- name: Taking database dump of {{ sitename }} {{ tier }}
#  shell: drush sql-dump | ssh {{ thost }} "cd {{ drupalroot }} && vendor/bin/drush sql:cli"

- tempfile:
    state:  file
    suffix: key
  register: temp_ssh_key

- copy:
    src: '{{ sshkey }}'
    dest: '{{ temp_ssh_key.path }}'

#- name: Copy file with owner and permissions
#  copy:
#    src: '{{ sshkey }}'
#    dest: temp.key
#    state: present

#- name: Dud in fhost
#  shell: touch fhost.dud

- name: Dud in thost
  shell: ssh -i {{ temp_ssh_key.path }} -o StrictHostKeyChecking=no {{ sshuser }}@{{ thost }} "touch thost.dud"

- name: Rsync to thost
  shell: rsync -a --delete -e "ssh -i {{ temp_ssh_key.path }}" testing.dud {{ sshuser }}@{{ thost }}:{{ drupalroot }}/ --rsync-path="dzdo rsync"
#- name: rsync the existing webdirectory against the target directory
#  shell: rsync -a --delete --exclude web/sites/default/settings.php web {{ thost }}:{{ drupalroot }}/
